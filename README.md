# 校园卡管理系统指南

## 一、系统概述

这是一个基于Flask后端和HTML+JS+CSS前端的校园卡管理系统，包含用户注册登录、校园卡报告查询、论坛交流、积分奖励、智能地点查询等功能。

## 二、功能特性

- **用户注册/登录**: 使用学号、姓名、密码进行注册和登录
- **报告捡到校园卡**: 发现校园卡时可以报告并选择处理方式，支持上传照片和联系方式
- **查询丢失校园卡**: 查询自己的校园卡是否被找到，支持连续查询和查询历史
- **公示列表**: 查看所有未认领的校园卡，展示热门丢失地点统计（支持卡片、柱状图、饼图三种视图）
- **论坛功能**: 发布和查看帖子，支持广告标记
- **奖励兑换**: 使用积分兑换奖品
- **智能地点查询**：支持模糊查询，可以通过AI分析知晓最近的招领点，给出建议

## 三、主体功能

### 1. 启动系统

```bash
python run_server.py
```

系统会自动打开浏览器并显示登录/注册页面。

### 2. 用户注册

在注册页面填写：

- 学号：任意数字（如：2023006）
- 姓名：你的姓名
- 密码：任意密码

点击"注册"按钮完成注册。

### 3. 用户登录

注册成功后会跳转到登录页面，使用刚才注册的信息登录。

或者使用预置的测试账号：

- 学号：2021001，姓名：张三，密码：123456

### 4. 功能演示

登录后进入首页，可以体验以下功能：

#### 4.1 报告捡到校园卡

- 点击"报告捡到校园卡"
- 填写校园卡号（如：2021007）
- 填写发现地点（如：图书馆三楼）
- 选择处理方式（自行联系或放置指定地点）
- 可以上传校园卡照片（支持jpg、png、gif格式，最大16MB）
- 上传后会显示图片预览，可以移除重新选择
- 提交报告

#### 4.2 查询丢失的校园卡

- 点击"查询丢失的校园卡"
- 输入学号查询（可以试试：2021004 或 2021005）
- 查看查询结果
- **功能说明**:
  - 可以连续查询多个学号，无需退出页面
  - 自动保存查询历史，点击历史记录可快速重新查询
  - 实时状态提示和结果高亮显示

#### 4.3 公示列表

- 点击"公示列表"
- 查看热门校园卡发现地点统计
  - 系统自动分析校园卡数据库中的地点字段
  - 将用户手动输入的地点转换成标准地点
  - 显示最近1个月的校园卡丢失地点（标准地点）
  - **多视图展示**: 支持卡片视图、柱状图、饼图三种展示方式
  - 前三名有特殊的排名标识（金银铜色）
  - 显示发现次数和占比百分比
  - **交互式图表**: 图表支持点击交互，可查看地点详情
  - **实时同步**: 所有视图数据保持同步更新
- 查看所有未认领的校园卡信息

#### 4.4 论坛功能

- 点击"论坛"查看现有帖子
- 点击"发布帖子"创建新帖子
- 可以选择是否标记为广告

#### 4.5 奖励兑换

- 点击"奖励兑换"
- 查看可兑换的奖品
- 使用积分兑换奖品（测试账号有不同的积分）

#### 4.5 智能地点查询

- 该功能使用DeepSeek AI模型来解析用户输入的地点信息，系统显示AI解析结果和最近的招领点信息。
  
- **智能地点解析**：使用DeepSeek AI模型解析用户自然语言输入；支持模糊描述，如"我在图书馆捡了钱包"，并提供置信度评估；备选关键词匹配机制，确保系统稳定性
  
- **最近招领点查找**：基于曼哈顿距离计算最近的招领点；自动返回距离和坐标信息；AI生成路线建议；语义排序，对于用户输入的模糊地点信息，如果检索出多个地点，按照置信度从大到小排序
  
- **地图标注**：对于找出的地点，在图片上进行标注，可视化展现
  
- **前期工作**：使用python cv2进行地图人工标注，生成标准地点文件（标准地点文件：建筑物信息、招领点信息、每个地点的坐标(x, y)和名称）
  
- **DeepSeek API配置**：
  

```python
DEEPSEEK_API_KEY = "your_actual_api_key"  # 替换为真实API密钥
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"
```

## 四、技术栈

### 后端

- Flask (Python Web框架)
- SQLAlchemy (ORM)
- SQLite (数据库)
- Flask-CORS (跨域支持)

### 前端

- HTML5
- CSS3 (响应式设计，支持移动端)
- JavaScript (原生JS，无框架依赖)

### 技术特点

#### - 前端特性

- 单页应用，流畅的页面切换
- 现代化的UI设计
- 图片上传和预览功能
- 文件类型和大小验证

#### - 后端特性

- RESTful API设计
- SQLite数据库，轻量级部署
- 数据脱敏处理
- 完整的CRUD操作
- 文件上传处理
- 图片存储和访问

#### - 数据安全

- 用户信息脱敏显示
- 基本的输入验证
- 错误处理机制

## 五、系统架构

```
前端 (HTML+CSS+JS)
    ↓ HTTP请求
后端 (Flask API)
    ↓ ORM
数据库 (SQLite)
```

## 六、数据模型

- **User**: 用户信息（学号student_id、姓名full_name、密码password、积分points）
- **CampusCard**: 校园卡信息（卡号card_number、学号student_id、状态status、发现地点found_location、发现时间found_time、联系方式选择handler_option、图片photo_url、具体联系方式contact、标准地点名称select_loc）
- **ForumPost**: 论坛帖子（标题title、内容content、作者author_id、时间created_at、是否为广告is_ad、是否为建议is_advice）
- **Reward**: 奖励信息（名称name、描述description、所需积分points_required）

## 七、技术细节

#### 系统已预置以下测试账号：

- **学号**: 2021001, **姓名**: 张三, **密码**: 123456, **积分**: 100
- **学号**: 2021002, **姓名**: 李四, **密码**: 123456, **积分**: 50
- **学号**: 2021003, **姓名**: 王五, **密码**: 123456, **积分**: 200

#### 主要的API接口

##### 1、用户相关

- `POST /register` - 用户注册
- `POST /login` - 用户登录

##### 2、校园卡相关

- `GET /query_lost_card` - 查询丢失的校园卡
- `POST /report_card` - 报告捡到校园卡

##### 3、地点相关

- `POST /smart_location_query` - 智能地点查询接口
- `GET /hot_locations` - 加载热门地点

##### 4、图片相关

- `POST /upload_image` - 上传图片
- `GET /uploads/<filename>` - 提供上传的图片文件

##### 5、奖励相关

- `GET /rewards` - 获取奖励列表
- `POST /reward/redeem` - 兑换奖励

##### 6、论坛相关

- `GET /forum/posts` - 获取论坛帖子列表
- `POST /forum/post` - 创建论坛帖子

##### 7、AI 建议相关

- `POST /get_ai_advice` - 获取 AI 智能建议（流式接口）
